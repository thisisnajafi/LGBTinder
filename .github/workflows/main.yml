name: LGBTinder Flutter App - Deployment Notification

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(git branch --show-current)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Notify Telegram - Deployment
        if: github.event_name == 'push'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_ACTOR: ${{ github.actor }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha_short }}
          BRANCH: ${{ steps.commit.outputs.branch }}
          COMMIT_MESSAGE: ${{ steps.commit.outputs.commit_message }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # Format commit message for Telegram
          FORMATTED_COMMIT_MESSAGE=$(echo "${COMMIT_MESSAGE}" | sed 's/"/\\"/g' | sed 's/$/\\n/' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          # Create deployment message
          MESSAGE="ğŸš€ <b>LGBTinder Flutter App</b> ğŸš€

          âœ… <b>Status:</b> Deployment Complete

          ğŸ“± <b>App:</b> LGBTinder Dating App
          ğŸ‘¤ <b>Deployed by:</b> ${GITHUB_ACTOR}
          ğŸŒ¿ <b>Branch:</b> ${BRANCH}
          ğŸ”— <b>Commit:</b> <code>${COMMIT_SHA}</code>

          ğŸ’¬ <b>Commit Message:</b>
          <blockquote>${FORMATTED_COMMIT_MESSAGE}</blockquote>

          âœ… <b>Deployment Tasks:</b>
          â€¢ Flutter build verification
          â€¢ Asset compilation
          â€¢ Platform-specific builds
          â€¢ Code quality checks

          ğŸ‰ <b>App Ready for Testing!</b>

          ğŸ“Š <b>Progress:</b> ~45% Complete
          ğŸ“‹ <b>Next:</b> Backend integration & missing screens"

          # Send to Telegram
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true

      - name: Notify Telegram - Pull Request
        if: github.event_name == 'pull_request'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_ACTOR: ${{ github.actor }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          MESSAGE="ğŸ”€ <b>LGBTinder Flutter App</b> ğŸ”€

          ğŸ“ <b>New Pull Request</b>

          ğŸ‘¤ <b>Author:</b> ${GITHUB_ACTOR}
          ğŸ”¢ <b>PR #${PR_NUMBER}</b>
          ğŸ“‹ <b>Title:</b> ${PR_TITLE}

          ğŸ”— <b>View PR:</b> ${PR_URL}

          âœ… <b>Ready for Review!</b>"

          # Send to Telegram
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true

      - name: Handle notification errors
        if: failure()
        run: |
          echo "âŒ Failed to send Telegram notification"
          echo "Check your TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID secrets"